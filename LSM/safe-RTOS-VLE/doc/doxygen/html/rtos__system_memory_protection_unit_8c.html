<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>safe-RTOS(VLE): rtos_systemMemoryProtectionUnit.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">safe-RTOS(VLE)
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">safe-RTOS (VLE) - A simple RTOS with safety support for MPC5643L</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('rtos__system_memory_protection_unit_8c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">rtos_systemMemoryProtectionUnit.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;stdbool.h&gt;</code><br />
<code>#include &lt;stdlib.h&gt;</code><br />
<code>#include &lt;assert.h&gt;</code><br />
<code>#include &quot;MPC5643L.h&quot;</code><br />
<code>#include &quot;<a class="el" href="typ__types_8h_source.html">typ_types.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="rtos_8h_source.html">rtos.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="rtos__system_memory_protection_unit_8h_source.html">rtos_systemMemoryProtectionUnit.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:af620f44dbc920ca8f7a2a92d67e70ff0"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rtos__system_memory_protection_unit_8c.html#af620f44dbc920ca8f7a2a92d67e70ff0">RTOS_DISARM_MPU</a>&#160;&#160;&#160;0</td></tr>
<tr class="separator:af620f44dbc920ca8f7a2a92d67e70ff0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6a541ac1979097bf99e9f1377d77c880"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a6a541ac1979097bf99e9f1377d77c880"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>WORD2</b>(access)&#160;&#160;&#160;(((((((access) &lt;&lt; 6) | (access)) &lt;&lt; 6) | (access)) &lt;&lt; 6) | (access))</td></tr>
<tr class="separator:a6a541ac1979097bf99e9f1377d77c880"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4d84c12357455d4ab8f0c4c0a0508cca"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a4d84c12357455d4ab8f0c4c0a0508cca"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>WORD3</b>(pid)&#160;&#160;&#160;(((pid)&lt;&lt;24) | 0x00000001u)</td></tr>
<tr class="separator:a4d84c12357455d4ab8f0c4c0a0508cca"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4ea2cafb6afb46293c8aecba2e261973"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a4ea2cafb6afb46293c8aecba2e261973"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>from</b>&#160;&#160;&#160;0</td></tr>
<tr class="separator:a4ea2cafb6afb46293c8aecba2e261973"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af6c611b6312d83f13b18d70d156aab8f"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="af6c611b6312d83f13b18d70d156aab8f"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>to</b>&#160;&#160;&#160;1</td></tr>
<tr class="separator:af6c611b6312d83f13b18d70d156aab8f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6890442e1cc24a0d61597a13576b8727"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a6890442e1cc24a0d61597a13576b8727"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>SDA</b>&#160;&#160;&#160;0</td></tr>
<tr class="separator:a6890442e1cc24a0d61597a13576b8727"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a02c7209e41a40542f1caff8b7284dbda"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a02c7209e41a40542f1caff8b7284dbda"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>SDA2</b>&#160;&#160;&#160;1</td></tr>
<tr class="separator:a02c7209e41a40542f1caff8b7284dbda"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aad9ae913bdfab20dd94ad04ee2d5b045"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="aad9ae913bdfab20dd94ad04ee2d5b045"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>DATA</b>&#160;&#160;&#160;2</td></tr>
<tr class="separator:aad9ae913bdfab20dd94ad04ee2d5b045"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa2361ca51795854813d69ee274b326e8"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="aa2361ca51795854813d69ee274b326e8"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>addrPrcAryAry</b>(prc)&#160;&#160;&#160;{[from] = addrAry(prc, Start), [to] = addrAry(prc, End)}</td></tr>
<tr class="separator:aa2361ca51795854813d69ee274b326e8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a4f1f4dbf31cbe5dd7c48a1f4ea2d594f"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="rtos__system_memory_protection_unit_8c.html#a4f1f4dbf31cbe5dd7c48a1f4ea2d594f">rtos_checkUserCodeWritePtr</a> (unsigned int PID, const void *address, size_t noBytes)</td></tr>
<tr class="separator:a4f1f4dbf31cbe5dd7c48a1f4ea2d594f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Configuration and initialization of the Memory Protection Unit (MPU). The configuration is chosen static in this sample. The initially chosen configuration is never changed during run-time.<br />
 The configuration uses a descriptor for all ROM, which is occupied by the compiled code: All processes have read and execution access. Write access, although it can't do any harm is forbidden: According run-time failure reporting will point to define implementation errors.<br />
 The configuration has one descriptor for all RAM, which is occupied by the compiled code. All processes have read access and only the OS process has write and execute access, too.<br />
 The configuration has one descriptor for the entire peripheral address space. The OS process has read and write access.<br />
 Each of the four user processes has three descriptors, all of them for RAM write and execute access. There's a descriptor for the initialized data and bss, one for the small data and bss and one for the small data 2 and bss 2.<br />
 The configuration has one descriptor for a chunk of memory, which all user processes have read and write access to. This memory is meant for inter-process communication and must evidently never be used to hold data, which is essential for the health of a process and in particular for the process, that implements supervisory safety tasks.<br />
 The static configuration of the MPU is the explanation for the fixed number of four supported processes (<a class="el" href="rtos_8h.html#a18500a557ecd5ebbcefbacba22b58d7e">RTOS_NO_PROCESSES</a>). We need three descriptors per user process at least three for the OS (including user ROM) and have 16 descriptors available.</p>
<p>CAUTION: The mentioned memory chunks or areas are puzzled by the linker. The MPU configuration makes no hard coded assumptions about memory arrangement and distribution or addresses and sizes of the chunks. It reads address and length of the memory chunks from linker provided symbols. Insofar do we have a very tight relationship between the implementation of this module and the linker script, which must be obeyed when doing maintenance work at either side.</p>
<p>Alternative configurations, which may find their use case and do not break the safety concept:</p><ul>
<li>The OS process doesn't necessarily need execution access for RAM. There are typically driver implementation patterns, which require RAM execution rights, but it is mostly about initialization and could be done prior to calling the MPU configuration.</li>
<li>The user processes won't normally need execution rights for their RAM</li>
<li>It is possible to let a process with higher privileges have access to the memories of all processes with lower privileges. Below, it is explained how to do this</li>
<li>If the number of processes is reduced (a safety concept requires two processes at minimum) then each process could have up to six descriptors. This would enable a configuration with disjunct data and bss chunks so that the waste of data image ROM disappears, which the current configuration has (see linker script for details)</li>
<li>The shared memory section can be disabled if not required for the inter-process communication</li>
<li>A difficult topic is the placing of the small data 2 and bss 2 sections. It is possible to locate them into the ROM. This is likely not fully compliant with the EABI but for all normal embedded applications alright. In which case we had four free descriptors and could implement two more processes. A similar concept for increasing the number of processes would be entirely switching off the short addressing modes. This is a matter of the compiler command line</li>
</ul>
<p>Copyright (C) 2018-2019 Peter Vranken (<a href="#" onclick="location.href='mai'+'lto:'+'Pet'+'er'+'_Vr'+'an'+'ken'+'@Y'+'aho'+'o.'+'de'; return false;">Peter<span style="display: none;">.nosp@m.</span>_Vra<span style="display: none;">.nosp@m.</span>nken@<span style="display: none;">.nosp@m.</span>Yaho<span style="display: none;">.nosp@m.</span>o.de</a>)</p>
<p>This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.</p>
<p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</p>
<p>You should have received a copy of the GNU General Public License along with this program. If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>. </p>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a class="anchor" id="af620f44dbc920ca8f7a2a92d67e70ff0"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RTOS_DISARM_MPU&#160;&#160;&#160;0</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Development support: If this define is set to one than the entire RAM is writable for all processes. </p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a4f1f4dbf31cbe5dd7c48a1f4ea2d594f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool rtos_checkUserCodeWritePtr </td>
          <td>(</td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>PID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&#160;</td>
          <td class="paramname"><em>address</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>noBytes</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Helper function, mainly intended to support safe system call handler implementation: Check if a pointer value is valid for writing in the context of a given process.<br />
 A system call handler must never trust a user code provided pointer; evidently not for write access but not even for read operation (a read into the address space of peripherals can have a side effect). The user code could make the system call handler overwrite some non-process owned data objects, cause an access violation in the supervisor code or manipulate some peripherals.<br />
 Normally, it's strongly disencouraged having pointers as arguments of system calls at all. If not avoidable, one can use this helper function to check that a pointer points into permitted address space and that all bytes of a data object pointed at are still in that address space. Here for write access.<br />
 Permitted address space is anywhere, where the process may write without causing an exception or any kind of side effect. In particular, this means the process' own RAM and the shared RAM. </p><dl class="section return"><dt>Returns</dt><dd>Get <em>true</em> if the pointer may be used for write access and <em>false</em> otherwise. </dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">PID</td><td>The ID of the process the query relates to. Range is 1..4. </td></tr>
    <tr><td class="paramname">address</td><td>The pointer value, or the beginning of the chunk of memory, which needs to be entirely located in writable memory. </td></tr>
    <tr><td class="paramname">noBytes</td><td>The size of the chunk of memory to be checked. Must not be less than one. (Checked by assertion). </td></tr>
  </table>
  </dd>
</dl>
<dl class="section remark"><dt>Remarks</dt><dd>The counterpart function rtos_checkUserCodeReadPtr() is implemented as inline function in the RTOS API header file, <a class="el" href="rtos_8h.html">rtos.h</a>. </dd>
<dd>
Although this function is intended for use inside a system call handler it can be safely used from user code, too. </dd></dl>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_050edd66366d13764f98250ef6db77f6.html">code</a></li><li class="navelem"><a class="el" href="dir_9cd24f4fec2e6f6bedbcc5407321d78a.html">system</a></li><li class="navelem"><a class="el" href="dir_34effe5aae1be93d744f092611be46f1.html">RTOS</a></li><li class="navelem"><a class="el" href="rtos__system_memory_protection_unit_8c.html">rtos_systemMemoryProtectionUnit.c</a></li>
    <li class="footer">Generated on Tue Sep 17 2019 22:34:24 for safe-RTOS(VLE) by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.8 </li>
  </ul>
</div>
</body>
</html>
